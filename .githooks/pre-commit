#!/usr/bin/env bash

# Check staged Lua files for stylua formatting
lua_files=$(git diff --cached --name-only --diff-filter=ACM -- '*.lua')

if [ -n "$lua_files" ]; then
  if ! command -v stylua &>/dev/null; then
    echo "WARNING: stylua is not installed — skipping formatting check."
    echo "Install stylua to enforce Lua formatting: brew install stylua"
  elif ! stylua --check $lua_files; then
    echo ""
    echo "ERROR: stylua formatting violations in staged files."
    echo "Run 'stylua .' to fix, then re-stage and commit."
    exit 1
  fi
fi

# Only run when README.md is staged
if ! git diff --cached --name-only | grep -q '^README\.md$'; then
  exit 0
fi

# Check for pandoc dependency
if ! command -v pandoc &>/dev/null; then
  echo "WARNING: pandoc is not installed — skipping vimdoc generation."
  echo "Install pandoc to auto-generate doc/gh-navigator.nvim.txt from README.md."
  exit 0
fi

echo "README.md changed — regenerating vimdoc..."

if make docs; then
  git add doc/gh-navigator.nvim.txt
else
  echo "ERROR: vimdoc generation failed."
  exit 1
fi
